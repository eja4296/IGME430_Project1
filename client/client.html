<!DOCTYPE html>
<html lang="en">
<head>
  <title>Article Review Creator</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    // function to parse the response
    const parseJSON = (xhr, content, bottomContent) => {
      // parse response (obj will be empty in a 204 updated)
      if(xhr.responseType === "HEAD"){
        return;
      }
      
      const obj = JSON.parse(xhr.response);
      console.dir(obj);
      
      //if message in response, add to screen
      if(obj.message) {
        const p = document.createElement('p');
        p.textContent = `Message: ${obj.message}`;
        content.appendChild(p);
      }
      
      //if reviews in response, add to screen
      if(obj.reviews) {
        const keys = Object.keys(obj.reviews);
        
        for(let i = 0; i < keys.length; i++){
          const review = obj.reviews[keys[i]];
          const newReview = document.createElement('div');
          const p1 = document.createElement('p');
          p1.innerHTML = `<b>Title:</b> ${review.title}`;
          newReview.appendChild(p1);
          
          const p2 = document.createElement('p');
          p2.innerHTML = `<b>Author:</b> ${review.authorFirstName} ${review.authorMiddleName}. ${review.authorLastName}, <b>Year:</b> ${review.year}`;
          newReview.appendChild(p2);
          
          const p3 = document.createElement('p');
          p3.innerHTML = `<b>Journal:</b> ${review.journal}, <b>Volume:</b> ${review.volume}, <b>Issue:</b> ${review.issue}, <b>Pages:</b> ${review.pages}`;
          newReview.appendChild(p3);
         
          const p4 = document.createElement('p');
          p4.innerHTML = `<b>Review:</b> ${review.review}`;
          newReview.appendChild(p4);
          
          // Citation
          const citation = document.createElement('p');
          citation.id = "citation";
          if(review.title && review.authorFirstName && review.authorLastName && review.journal && review.volume && review.issue && review.pages){
            const firstInitial = review.authorFirstName;
            citation.innerHTML = `<b>APA Citation:</b> ${review.authorLastName}, ${firstInitial.charAt(0)}.`;
            newReview.appendChild(citation);
            if(review.authorMiddleName){
              citation.innerHTML += ` ${review.authorMiddleName}.`
            }
            citation.innerHTML += ` (${review.year}). ${review.title}. <i>${review.journal}, ${review.volume}</i>(${review.issue}), ${review.pages}`;
          }else{
            citation.innerHTML = "<b>APA Citation:</b> More information needed for accurate citation.";
            newReview.appendChild(citation);
          }
          
          // Append all added content
          bottomContent.appendChild(newReview);
        }
      }
    };
    // handle response
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');
      const bottom = document.querySelector('#bottom');
      
      
      //check the status code
      switch(xhr.status) {
        case 200: // success
          content.innerHTML = `<b>Successfully Retrieved Reviews</b>`;
          bottom.removeChild(document.querySelector('#bottomContent'));
          const bottomContent = document.createElement('section');
          bottomContent.id = "bottomContent";
          bottom.appendChild(bottomContent);
          break;
        case 201: // created
          content.innerHTML = '<b>Created Review Added Successfully</b>';
          break;
        case 204: // updated
          content.innerHTML = '<b>Updated Review Successfully</b>';
          return;
        case 400: // bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: // not found
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
        default: // other
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
      // Only parse JSON if it is not a head request
      if(parseResponse) {
        parseJSON(xhr, content, bottomContent);
      }
    };
    //function to send post request
    const sendPost = (e, reviewForm) => {
      const reviewAction = reviewForm.getAttribute('action');
      const reviewMethod = reviewForm.getAttribute('method');
      
      const titleField = reviewForm.querySelector('#titleField');
      const authorFirstField = reviewForm.querySelector('#authorFirstField');
      const authorMiddleField = reviewForm.querySelector('#authorMiddleField');
      const authorLastField = reviewForm.querySelector('#authorLastField');
      const yearField = reviewForm.querySelector('#yearField');
      const journalField = reviewForm.querySelector('#journalField');
      const volumeField = reviewForm.querySelector('#volumeField');
      const issueField = reviewForm.querySelector('#issueField');
      const pagesField = reviewForm.querySelector('#pagesField');
      const reviewField = reviewForm.querySelector('#reviewField');
      
      const xhr = new XMLHttpRequest();
      xhr.open(reviewMethod, reviewAction);
      
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr, true);
      
      const formData = `title=${titleField.value}&authorFirstName=${authorFirstField.value}&authorMiddleName=${authorMiddleField.value}&authorLastName=${authorLastField.value}&year=${yearField.value}&journal=${journalField.value}&volume=${volumeField.value}&issue=${issueField.value}&pages=${pagesField.value}&review=${reviewField.value}`;
      
      xhr.send(formData);
      
      // Prevent page from changing
      e.preventDefault();
      return false;
    };
    // function to get user data
    const getData = (e, userForm) => {
      const userAction = userForm.getAttribute('action');
      const userMethod = userForm.getAttribute('method');
      
      const urlField = document.querySelector('#urlField').value;
      const methodField = document.querySelector('#methodSelect').value;
      
      const xhr = new XMLHttpRequest();
      xhr.open(methodField, urlField);
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr);
      
      // check if head or get
      if(methodField == 'get') {
        // if get, we want to parse JSON from body
        xhr.onload = () => handleResponse(xhr, true);
      } else {
        // if head, there is no body
        xhr.onload = () => handleResponse(xhr, false);
      }
      
      xhr.send();
      
      e.preventDefault();
      return false;
    };
    const init = () => {
      const reviewForm = document.querySelector('#reviewForm');
      const userForm = document.querySelector('#userForm');
      
      const addReview = (e) => sendPost(e, reviewForm);
      const getReviews = (e) => getData(e, userForm);
      
      reviewForm.addEventListener('submit', addReview);
      userForm.addEventListener('submit', getReviews);
    };
    window.onload = init;
  </script>
</head>
<body>
  <section id="main">
  <section id="top">
    <h1>Create Article Reviews</h1>
    <h3>Enter information about an article you read to help you write your papers later on!</h3>
    <p id="required">*Required Field</p>
    <form id="reviewForm" action="/addReview" method="post">
      <div id="leftReviewForm">
        <label for="title">*Title: </label>
        <input id="titleField" placeholder="e.g. Video Games and Mental Health" type="text" name="title" />
        <label for="authorFirstName">Author: </label>
        <div id="authorName">
          <input id="authorFirstField" placeholder="First Name" type="text" name="authorFirstName"/>
          <input id="authorMiddleField" placeholder="Middle Initial" type="text" name="authorMiddleName"/>
          <input id="authorLastField" placeholder="Last Name" type="text" name="authorLastName"/>
        </div>
        <label for="year">Year: </label>
        <input id="yearField" placeholder="e.g. 2012" type="text" name="year"/>
        <label for="journal">Journal: </label>
        <input id="journalField" placeholder="e.g. Journal of Cognitive Neuroscience" type="text" name="journal"/>
        <label for="volume">Volume: </label>
        <input id="volumeField" placeholder="e.g. 12" type="text" name="volume"/>
        <label for="issue">Issue: </label>
        <input id="issueField" placeholder="e.g. 3" type="text" name="issue"/>
        <label for="pages">Pages: </label>
        <input id="pagesField" placeholder="e.g. 219-234" type="text" name="pages"/>
      </div>
      <div id="rightReviewForm">
        <label for="review">*Review: </label>
        <textarea id="reviewField" rows="25" placeholder="Review of the article..." name="review"></textarea>
      </div>
        <div id="addReviewButton">
        <input type="submit" value="Add Review" />
        </div>
    </form>
    <section id="content"></section>
  </section>
    
  <section id="bottom">
    <h1>Read Article Reviews</h1>
    <form id="userForm" action="/getReviews" method="get">
      <select id='urlField'>
        <option value='/getReviews'>/getReviews</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get Reviews" />
    </form>
    <section id=bottomContent></section>
  </section>
    <footer>
        &copy; 2018 Erik Azzarano
    </footer>
 </section>

</body>
</html>